# Layer configuration
BBPATH .= ":${LAYERDIR}"

# Look for .bb files in recipes/ folder and subdirectories
BBFILES += "${LAYERDIR}/recipes/*.bb \
            ${LAYERDIR}/recipes*/*.bb \
            ${LAYERDIR}/recipes*/*.bbappend \
            ${LAYERDIR}/recipes*/*/*.bb \
            ${LAYERDIR}/recipes*/*/*.bbappend \
            ${LAYERDIR}/recipes*/*/*/*.bb \
            ${LAYERDIR}/recipes*/*/*/*.bbappend"

BBFILE_COLLECTIONS += "jvideo-pipeline"
BBFILE_PATTERN_jvideo-pipeline = "^${LAYERDIR}/"
BBFILE_PRIORITY_jvideo-pipeline = "10"

QB_MEM = "-m 2048"
LAYERDEPENDS_jvideo-pipeline = "core"
LAYERSERIES_COMPAT_jvideo-pipeline = "kirkstone"

# SystemD configuration
DISTRO_FEATURES:append = " systemd"
DISTRO_FEATURES_BACKFILL_CONSIDERED += "sysvinit"
VIRTUAL-RUNTIME_init_manager = "systemd"
VIRTUAL-RUNTIME_initscripts = "systemd-compat-units"

# Accept necessary licenses for commercial codecs
LICENSE_FLAGS_ACCEPTED = "commercial"

# FFmpeg configuration - use valid PACKAGECONFIG options for Kirkstone
PACKAGECONFIG:append:pn-ffmpeg = " \
    gpl \
    openssl \
"

# Use EXTRA_OECONF for codec-specific options instead
EXTRA_OECONF:append:pn-ffmpeg = " \
    --enable-libmp3lame \
    --enable-libx264 \
    --enable-libx265 \
    --enable-libvpx \
    --enable-nonfree \
"

# Enable FFmpeg support in OpenCV - force rebuild
PACKAGECONFIG:append:pn-opencv = " ffmpeg"
DEPENDS:append:pn-opencv = " ffmpeg"

# Ensure GStreamer support in OpenCV (if needed)
PACKAGECONFIG:append:pn-opencv = " gstreamer"

# Install GStreamer plugins and development packages
IMAGE_INSTALL:append = " \
    gstreamer1.0 \
    gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good \
    gstreamer1.0-plugins-bad \
    gstreamer1.0-plugins-ugly \
    gstreamer1.0-libav \
    gstreamer1.0-plugins-base-apps \
    gstreamer1.0-dev \
    gstreamer1.0-plugins-base-dev \
    gstreamer1.0-plugins-base-meta \
    gstreamer1.0-plugins-good-meta \
"

# Optional: Add additional video-related packages for debugging
IMAGE_INSTALL:append = " \
    ffmpeg \
    v4l-utils \
    gst-examples \
"
